{% extends "layouts/page-with-menu.html" %}
{% import "macros/docs.html" as docs_macros %}

{% block head_extensions %}
    <script src="/optional-helpers.js"></script>
{% endblock %}

{% block mobile_page_menu %}
    {% set root_section_path = current_path | split(pat="/") | slice(start=1, end=3) | concat(with="_index.md") | join(sep="/") %}
    {{ docs_macros::docs_menu(prefix="mobile-menu", root=get_section(path=root_section_path)) }}
{% endblock %}

{% block page_menu %}
    {% set root_section_path = current_path | split(pat="/") | slice(start=1, end=3) | concat(with="_index.md") | join(sep="/") %}
    {{ docs_macros::docs_menu(prefix="page-menu", root=get_section(path=root_section_path)) }}
{% endblock %}

{% block page_content %}
<div class="docs-page">
    <div class="docs-content">
        {% set root_section_path = current_path | split(pat="/") | slice(start=1, end=3) | concat(with="_index.md") | join(sep="/") %}
        {% set root_section = get_section(path=root_section_path) %}
        {# Create an array of sections and pages in reading order #}
        {% set all_pages = [] %}

        {% set subsections = [] %}
        {% for section in root_section.subsections %}
            {% set_global subsections = subsections | concat(with=get_section(path=section)) %}
        {% endfor %}
        {% set pages_and_sections = root_section.pages | concat(with=subsections) | sort(attribute="extra.weight") %}

        {% for i in range(end=3) %}
            {% for p in pages_and_sections %}
                {% set_global all_pages = all_pages | concat(with=p) %}
                {% if subsections is containing(p) %}
                    {% set_global subsections = [] %}
                    {% for section in p.subsections %}
                        {% set_global subsections = subsections | concat(with=get_section(path=section)) %}
                    {% endfor %}
                    {% set_global pages_and_sections = p.pages | concat(with=subsections) %}
                {% endif %}
            {% endfor %}
        {% endfor %}

        {# Find prev/next pages #}
        {% set prev_page = false %}
        {% set next_page = false %}
        {% set found_current = false %}

        {% for p in all_pages %}
            {% set parent_section_path = p.components | slice(end=-1) | concat(with="_index.md") | join(sep="/") %}
            {% set parent_section = get_section(path=parent_section_path) %}

            {% if found_current %}
                {% if p.extra and p.extra.public_draft %}
                    {% continue %}
                {% elif parent_section.extra and parent_section.extra.public_draft %}
                    {% continue %}
                {% endif %}
                {% set_global next_page = p %}
                {% break %}
            {% endif %}

            {% if current_path == p.path %}
                {% set_global found_current = true %}
                {% continue %}
            {% endif %}

            {% if p.extra and p.extra.public_draft %}
                {% continue %}
            {% elif parent_section.extra and parent_section.extra.public_draft %}
                {% continue %}
            {% endif %}
            {% set_global prev_section = p %}
        {% endfor %}

        <h1>
            {% block docs_page_title %}{% endblock %}
        </h1>
        <div class="media-content">{% block docs_page_content%}{% endblock %}</div>
        <div class="docs-footer">
            <nav class="docs-footer__nav">
                {% if next_page %}
                    <a class="docs-footer__link docs-footer__link--next" href="{{ next_page.path }}" data-docs-nav-next>
                        <div class="docs-footer__label">
                            <div class="docs-footer__dir">Next</div>
                            {{ next_page.title }}
                        </div>
                        <i class="docs-footer__chevron icon icon--chevron-right"></i>
                    </a>
                {% endif %}
                {% if prev_page %}
                    <a class="docs-footer__link docs-footer__link--prev" href="{{prev_page.path}}" data-docs-nav-previous>
                        <div class="docs-footer__label">
                            <div class="docs-footer__dir">Previous</div>
                            {{ prev_page.title }}
                        </div>
                        <i class="docs-footer__chevron icon icon--chevron-left"></i>
                    </a>
                {% endif %}
            </nav>
            <div class="docs-footer__edit-wrapper">
                <a class="docs-footer__edit" href="https://github.com/bevyengine/bevy-website/edit/main/content/{% block docs_page_relative_path %}{% endblock %}">
                    <i class="icon icon--pencil"></i>
                    Improve this page
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

